name: Build and Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: reactjs-app

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Create Dockerfile dynamically
    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        # Build stage
        FROM node:20-alpine AS builder
        
        WORKDIR /app
        
        # Copy package files
        COPY package*.json ./
        
        # Install dependencies
        RUN npm ci
        
        # Copy all files
        COPY . .
        
        # Build the app
        RUN npm run build
        
        # Production stage
        FROM node:20-alpine
        
        WORKDIR /app
        
        # Install serve to run the build
        RUN npm install -g serve
        
        # Copy build from builder stage
        COPY --from=builder /app/dist ./dist
        
        # Expose port
        EXPOSE 3000
        
        # Start the app
        CMD ["serve", "-s", "dist", "-l", "3000"]
        EOF
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
                     -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
    
    - name: Test Docker image
      run: |
        docker run --rm -d --name reactjs-service \
          -p 3000:3000 \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
        sleep 10
        
        # Check if container is running
        docker ps | grep reactjs-service || exit 1
        
        # Stop test container
        docker stop reactjs-service
    
    - name: Push Docker image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Image digest
      run: echo "Image pushed successfully!"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    
    steps:
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment on AWS EC2..."
          
          # Login to Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # Pull the latest image
          echo "ğŸ“¦ Pulling latest Docker image..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Stop and remove old container if exists
          echo "ğŸ›‘ Stopping old container..."
          docker stop reactjs-app 2>/dev/null || true
          docker rm reactjs-app 2>/dev/null || true
          
          # Kill any process using port 3000
          echo "ğŸ” Checking for processes on port 3000..."
          if lsof -ti:3000 > /dev/null 2>&1; then
            echo "âš ï¸  Port 3000 is in use, killing process..."
            lsof -ti:3000 | xargs kill -9 2>/dev/null || true
            sleep 2
          fi
          
          # Remove any containers using port 3000
          CONTAINER_ON_PORT=$(docker ps -a --filter "publish=3000" --format "{{.Names}}" 2>/dev/null || true)
          if [ ! -z "$CONTAINER_ON_PORT" ]; then
            echo "ğŸ—‘ï¸  Removing container using port 3000: $CONTAINER_ON_PORT"
            docker stop $CONTAINER_ON_PORT 2>/dev/null || true
            docker rm $CONTAINER_ON_PORT 2>/dev/null || true
          fi
          
          # Run new container
          echo "â–¶ï¸  Starting new container..."
          docker run -d \
            --name reactjs-app \
            -p 3000:3000 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Wait for container to start
          sleep 5
          
          # Check if container is running
          if docker ps | grep -q reactjs-app; then
            echo "âœ… Container is running successfully!"
            docker ps | grep reactjs-app
          else
            echo "âŒ Container failed to start!"
            echo "Container logs:"
            docker logs reactjs-app
            exit 1
          fi
          
          # Clean up old Docker images (keep last 3)
          echo "ğŸ§¹ Cleaning up old images..."
          docker images | grep "${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}" | tail -n +4 | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
          
          # Show container status
          echo "ğŸ“Š Current container status:"
          docker ps -a | grep reactjs-app
          
          echo "ğŸ‰ Deployment completed successfully!"
    
    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ” Verifying deployment..."
          
          # Check container logs (last 30 lines)
          echo "ğŸ“‹ Container logs:"
          docker logs --tail 30 reactjs-app
          
          # Check container health
          echo "ğŸ¥ Container health check:"
          docker inspect reactjs-app --format='{{.State.Status}}'
          
          # Test if app is responding
          echo "ğŸŒ Testing application response..."
          curl -f http://localhost:3000 || echo "âš ï¸  Warning: Application not responding on port 3000"
          
          echo "âœ… Verification complete!"
    
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ âœ… Deployment successful!"
          echo "Your React app is now running at http://${{ secrets.EC2_HOST }}:3000"
        else
          echo "âŒ Deployment failed!"
          echo "Check the logs above for more details."
        fi